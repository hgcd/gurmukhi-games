{% extends "base.html" %}

{% block title %}Analytics{% endblock %}

{% block content %}
<div class="w-100 bg-none rounded-3 p-4" style="min-width: 50em;">
    <h5 class="text-center">
        <span class="eng-lang-text">Gurmukhi Games Analytics</span>
        <span class="pa-lang-text">ਗੁਰਮੁਖੀ ਖੇਡਾਂ ਨਿਖੇੜਾ</span>
    </h5>
    <br/>

    <div class="p-4 m-2 d-flex flex-row justify-content-center">
        <!-- Filter options -->
        <div class="mx-1" style="min-width: 7em;">
            <label for="class-filter-select" class="form-label">
                <span class="eng-lang-text">Class</span>
                <span class="pa-lang-text">ਜਮਾਤ</span>
            </label>
            <select id="class-filter-select" class="form-select border border-dark border-2 rounded-3">
                <option value="all">All</option>
                <option value="class-1-summer-2025">Class 1 Summer 2025</option>
                <option value="class-1-fall-2025">Class 1 Fall 2025</option>
                <option value="class-2-fall-2025">Class 2 Fall 2025</option>
            </select>
        </div>
        <div class="mx-1" style="min-width: 7em;">
            <label for="game-filter-select" class="form-label">
                <span class="eng-lang-text">Game</span>
                <span class="pa-lang-text">ਖੇਡ</span>
            </label>
            <select id="game-filter-select" class="form-select border border-dark border-2 rounded-3">
                <option value="all">All</option>
            </select>
        </div>
        <div class="mx-1" style="min-width: 7em;">
            <label for="category-filter-select" class="form-label">
                <span class="eng-lang-text">Category</span>
                <span class="pa-lang-text">ਸ਼੍ਰੇਣੀ</span>
            </label>
            <select id="category-filter-select" class="form-select border border-dark border-2 rounded-3">
                <option value="all">All</option>
            </select>
        </div>
        <div class="mx-1" style="min-width: 7em;">
            <label for="student-filter-select" class="form-label">
                <span class="eng-lang-text">Student</span>
                <span class="pa-lang-text">ਵਿਧਿਆਰਥੀ</span>
            </label>
            <select id="student-filter-select" class="form-select border border-dark border-2 rounded-3">
                <option value="all">All</option>
            </select>
        </div>
        <div class="mx-1" style="min-width: 7em;">
            <label for="date-filter-select" class="form-label">
                <span class="eng-lang-text">Date</span>
                <span class="pa-lang-text">ਤਰੀਖ</span>
            </label>
            <select id="date-filter-select" class="form-select border border-dark border-2 rounded-3">
                <option value="all">All</option>
                <option value="last_month">Last month</option>
                <option value="last_week" selected>Last week</option>
                <option value="today">Today</option>
            </select>
        </div>
        <div class="mx-1 d-flex align-items-end">
            <button class="btn-press-flat bg-blue pt-2" style="min-width: 5em;" onclick="updateAnalytics()">
                <h6>
                    <span class="eng-lang-text">Filter</span>
                    <span class="pa-lang-text">ਫ਼ਿਲਟਰ</span>
                </h6>
            </button>
        </div>
    </div>

    <div id="error-message" class="text-center bg-red p-2 rounded-3 d-none mb-2"></div>

    <div class="d-flex flex-wrap justify-content-center">
        <div class="bg-main-light rounded-3 p-4 m-2" style="width: 45%;">
            <!-- Activities pie chart -->
            <h5 class="text-center">
                <span class="eng-lang-text">Game Categories</span>
                <span class="pa-lang-text">ਖੇਡ ਵੰਡ</span>
            </h5>
            <div id="activityTypesPieChart-container" class="d-flex justify-content-center align-items-center" style="height: 200px;">
                <div class="spinner-border" role="status">
                    <span class="sr-only">Loading...</span>
                </div>
            </div>
            <canvas id="activityTypesPieChart" class="d-none"></canvas>
        </div>

        <div class="bg-main-light rounded-3 p-4 m-2" style="width: 45%;">
            <!-- Activity categories pie chart -->
            <h5 class="text-center">
                <span class="eng-lang-text">Game Categories</span>
                <span class="pa-lang-text">ਖੇਡ ਸ਼੍ਰੇਣੀ ਵੰਡ</span>
            </h5>
            <div id="activityCategoriesPieChart-container" class="d-flex justify-content-center align-items-center" style="height: 200px;">
                <div class="spinner-border" role="status">
                    <span class="sr-only">Loading...</span>
                </div>
            </div>
            <canvas id="activityCategoriesPieChart" class="d-none"></canvas>
        </div>

        <!-- User bar chart -->
        <div class="bg-main-light rounded-3 p-4 m-2" style="width: 90%;">
            <h5 class="text-center">
                <span class="eng-lang-text">Students</span>
                <span class="pa-lang-text">ਵਿਧਿਆਰਥੀ</span>
            </h5>
            <div id="userActivitiesBarChart-container" class="d-flex justify-content-center align-items-center" style="height: 300px;">
                <div class="spinner-border" role="status">
                    <span class="sr-only">Loading...</span>
                </div>
            </div>
            <canvas id="userActivitiesBarChart" class="d-none"></canvas>
        </div>

        <!-- Usage stats -->
        <div class="bg-main-light rounded-3 p-4 m-2" style="width: 90%;">
            <h5 class="text-center">
                <span class="eng-lang-text">Usage Stats</span>
                <span class="pa-lang-text">ਵਰਤੋਂ ਸੰਖੇਪ</span>
            </h5>
            <div id="usageStatsChart-container" class="d-flex justify-content-center align-items-center" style="height: 200px;">
                <div class="spinner-border" role="status">
                    <span class="sr-only">Loading...</span>
                </div>
            </div>
            <canvas id="usageStatsChart" class="d-none"></canvas>
        </div>
    </div>

    <div class="d-flex flex-wrap justify-content-center">
        <!-- Painti akhar grid stats -->
        <div class="bg-main-light rounded-3 p-4 m-2" style="width: 45%;">
            <h5 class="text-center">
                <span class="eng-lang-text">Akhar Accuracy</span>
                <span class="pa-lang-text">ਅੱਖਰ ਅੰਕੜੇ</span>
            </h5>
            <table class="table table-striped">
                {% for row in [["ੳ", "ਅ", "ੲ", "ਸ", "ਹ"], ["ਕ", "ਖ", "ਗ", "ਘ", "ਙ"], ["ਚ", "ਛ", "ਜ", "ਝ", "ਞ"], ["ਟ", "ਠ", "ਡ", "ਢ", "ਣ"], ["ਤ", "ਥ", "ਦ", "ਧ", "ਨ"], ["ਪ", "ਫ", "ਬ", "ਭ", "ਮ"], ["ਯ", "ਰ", "ਲ", "ਵ", "ੜ"], ["ਸ਼", "ਜ਼", "ਫ਼", "ਖ਼", "ਗ਼", "ਲ਼"]] %}
                <div class="row">
                    {% for akhar in row %}
                    <div class="col-xl p-1" style="max-width: 20%;">
                        <button id="akhar-{{ akhar }}" class="btn-press-blank w-100 border border-2 border-dark" style="background-color: rgba(0, 0, 0, 0);">
                            <h1>{{ akhar }}</h1>
                            <p id="akhar-accuracy-text-{{ akhar }}">-%<br/>0/0</p>
                        </button>
                    </div>
                    {% endfor %}
                </div>
                {% endfor %}
            </table>
        </div>

        <!-- Laga matra grid stats -->
        <div class="bg-main-light rounded-3 p-4 m-2" style="width: 45%;">
            <h5 class="text-center">
                <span class="eng-lang-text">Laga Matra Accuracy</span>
                <span class="pa-lang-text">ਲਗਾ ਮਾਤਰਾ ਅੰਕੜੇ</span>
            </h5>
            <table class="table table-striped">
                {% for row in [["(ਅ)", "ਿ", "ੁ", "ੋ", "ੇ"], ["ਾ", "ੀ", "ੂ", "ੌ", "ੈ"]] %}
                <div class="row">
                    {% for akhar in row %}
                    <div class="col-xl p-1" style="max-width: 20%;">
                        <button id="akhar-{{ akhar }}" class="btn-press-blank w-100 border border-2 border-dark" style="background-color: rgba(0, 0, 0, 0);">
                            <h1>{{ akhar }}</h1>
                            <p id="akhar-accuracy-text-{{ akhar }}">-%<br/>(0/0)</p>
                        </button>
                    </div>
                    {% endfor %}
                </div>
                {% endfor %}
            </table>
        </div>

        <!-- Akhar timeline -->
        <div class="bg-main-light rounded-3 p-4 m-2" style="width: 90%;">
            <h5 class="text-center">
                <span class="eng-lang-text">Akhar Score Timeline</span>
                <span class="pa-lang-text">ਅੱਖਰ ਸਕੋਰ ਟਾਈਮਲਾਇਨ</span>
            </h5>
            <div id="akharTimelineChart-container" class="d-flex justify-content-center align-items-center" style="height: 300px;">
                <div class="spinner-border" role="status">
                    <span class="sr-only">Loading...</span>
                </div>
            </div>
            <canvas id="akharTimelineChart" class="d-none"></canvas>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/analytics.js') }}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        updateAnalytics();
    });

    function updateAnalytics() {
        // Show loading spinner
        showAllLoadingSpinners();
        destroyAllCharts();

        // Get analytics data with AJAX
        $.ajax({
            url: '/get-analytics',
            type: 'GET',
            data: {
                class_id: $('#class-filter-select').val(),
                game: $('#game-filter-select').val(),
                category: $('#category-filter-select').val(),
                student_id: $('#student-filter-select').val(),
                recency: $('#date-filter-select').val()
            },
            success: function(response) {
                // Display analytics
                displayAnalytics(response);
            },
            error: function(error) {
                alert('Error updating analytics: ' + error);
            }
        });
    }
</script>
{% endblock %}
